<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Cross-sectional forecast reconciliation • FoReco</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="Cross-sectional-forecast-reconciliation_files/libs/quarto-html/popper.min.js"></script><script src="Cross-sectional-forecast-reconciliation_files/libs/quarto-html/tippy.umd.min.js"></script><link href="Cross-sectional-forecast-reconciliation_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Cross-sectional-forecast-reconciliation_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Cross-sectional forecast reconciliation">
<meta property="og:image" content="https://danigiro.github.io/FoReco/logo.svg">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">FoReco</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.1.0.9012</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span> Home</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-book"></span> Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fa-question-circle"></span> Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/Dataset-vndata-and-itagdp.html">The `vndata` and `itagdp` dataset</a></li>
    <li><a class="dropdown-item" href="../articles/Cross-sectional-forecast-reconciliation.html">Cross-sectional forecast reconciliation</a></li>
    <li><a class="dropdown-item" href="../articles/Temporal-forecast-reconciliation.html">Temporal forecast reconciliation</a></li>
    <li><a class="dropdown-item" href="../articles/Cross-temporal-forecast-reconciliation.html">Cross-temporal forecast reconciliation</a></li>
    <li><a class="dropdown-item" href="../articles/Replicate-the-hts-package.html">Replicate the `hts` package</a></li>
    <li><a class="dropdown-item" href="../articles/Replicate-the-thief-package.html">Replicate the `thief` package</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html"><span class="fa far fa-newspaper"></span> News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/danigiro/FoReco" aria-label="View on GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://cran.r-project.org/web/packages/FoReco/index.html" aria-label="View on CRAN"><span class="fa fab fa-r-project fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Cross-sectional forecast reconciliation</h1>

      <p class="author">Daniele Girolimetto</p>
      <p class="date">2025-09-26</p>

      <small class="dont-index">Source: <a href="https://github.com/danigiro/FoReco/blob/HEAD/vignettes/articles/Cross-sectional-forecast-reconciliation.qmd" class="external-link"><code>vignettes/articles/Cross-sectional-forecast-reconciliation.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <section class="section level2"><h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette demonstrates the use of the <code>FoReco</code> package for cross-sectional forecast reconciliation. We will work through examples using grouped and general linearly constrained time series, showing how to obtain base forecasts, reconcile these forecasts, and address practical challenges such as non-negativity constraints and immutable forecasts. We will also explore probabilistic forecast reconciliation.</p>
<section class="level2"><h3 id="packages">Packages<a class="anchor" aria-label="anchor" href="#packages"></a>
</h3>
<p>First, we load the necessary packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/danigiro/FoReco" class="external-link">FoReco</a></span><span class="op">)</span>   <span class="co"># -&gt; To perform reconciliation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pkg.robjhyndman.com/forecast/" class="external-link">forecast</a></span><span class="op">)</span>  <span class="co"># -&gt; To obtain base forecasts</span></span></code></pre></div>
</div>
</section></section><section class="section level2"><h2 id="vndata-groupped-time-series">
<code>vndata</code>: Groupped time series<a class="anchor" aria-label="anchor" href="#vndata-groupped-time-series"></a>
</h2>
<p>We will use the <code>vndata</code> dataset <span class="citation" data-cites="Wickramasuriya2019">(<a href="#ref-Wickramasuriya2019" role="doc-biblioref">Wickramasuriya et al., 2018</a>)</span>, which contains grouped time series data, and <code>vnaggmat</code>, which is the corresponding aggregation matrix. See the <a href="Dataset-vndata-and-itagdp.html">dataset vignette</a> for more details.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">vndata</span><span class="op">)</span>      <span class="co"># dataset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">vnaggmat</span><span class="op">)</span>    <span class="co"># Agg mat matrix</span></span></code></pre></div>
</div>
<section class="level2"><h3 id="base-forecast">Base forecast<a class="anchor" aria-label="anchor" href="#base-forecast"></a>
</h3>
<p>To obtained the base forecasts, we fit an ETS model with log transformation to each series. We handle zeros by replacing them with half the minimum non-zero value in the series <span class="citation" data-cites="Wickramasuriya2020-zk">(<a href="#ref-Wickramasuriya2020-zk" role="doc-biblioref">Wickramasuriya et al., 2020</a>)</span>, then fit the ETS model and generate forecasts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode<span class="op">=</span><span class="st">'list'</span>, length<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">vndata</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">vndata</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fc_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode<span class="op">=</span><span class="st">'list'</span>, length<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">vndata</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">vndata</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ETS model with log transformation</span></span>
<span><span class="va">ets_log</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">[</span><span class="va">x</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">x</span><span class="op">!=</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span></span>
<span>  <span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/ets.html" class="external-link">ets</a></span><span class="op">(</span><span class="va">x</span>, lambda <span class="op">=</span> <span class="fl">0</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">vndata</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">model</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">ets_log</span><span class="op">(</span><span class="va">vndata</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">fc_obj</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">model</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, h <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<p>We extract the point forecasts and residuals from the fitted models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Point forecasts</span></span>
<span><span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fc_obj</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">base</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Time-Series [1:12, 1:525] from 2017 to 2018: 50651 21336 24567 29800 22846 ...</span></span>
<span><span class="co"># Residuals</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fc_obj</span>, <span class="va">residuals</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">res</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Time-Series [1:228, 1:525] from 1998 to 2017: 2143 -970 -115 133 951 ...</span></span></code></pre></div>
</div>
</section><section class="level2"><h3 id="point-forecast-reconciliation">Point forecast reconciliation<a class="anchor" aria-label="anchor" href="#point-forecast-reconciliation"></a>
</h3>
<p>We apply various reconciliation methods to the base forecasts to ensure they add up correctly across different levels of aggregation.</p>
<p>Bottom-up reconciliation <span class="citation" data-cites="Dunn1976-kv">(<a href="#ref-Dunn1976-kv" role="doc-biblioref">Dunn et al., 1976</a>)</span> aggregates forecasts from the lowest level to higher levels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fc_bts</span> <span class="op">&lt;-</span> <span class="va">base</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">vnaggmat</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">rf_bu</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/csbu.html">csbu</a></span><span class="op">(</span><span class="va">fc_bts</span>, agg_mat <span class="op">=</span> <span class="va">vnaggmat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">rf_bu</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:12, 1:525] 44094 18218 20585 25563 19385 ...</span></span></code></pre></div>
</div>
<p>In the top-down reconciliation for genuine hierarchical/grouped time series <span class="citation" data-cites="Gross1990-uf">(<a href="#ref-Gross1990-uf" role="doc-biblioref">Gross &amp; Sohl, 1990</a>)</span>, the forecast of <code>Total</code> (top-level series, expected to be positive) is disaggregated according to a proportional scheme (weights) such that:</p>
<ul>
<li><p>the top-level value remains unchanged;</p></li>
<li><p>all the bottom time series reconciled forecasts are non-negative.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bts</span> <span class="op">&lt;-</span> <span class="va">vndata</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">vnaggmat</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">total</span> <span class="op">&lt;-</span> <span class="va">vndata</span><span class="op">[</span>, <span class="st">"Total"</span><span class="op">]</span></span>
<span><span class="va">fc_total</span> <span class="op">&lt;-</span> <span class="va">base</span><span class="op">[</span>, <span class="st">"Total"</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Average historical proportions - Gross-Sohl method A</span></span>
<span><span class="va">p_gsa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bts</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">/</span><span class="va">total</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rf_td_gsa</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cstd.html">cstd</a></span><span class="op">(</span><span class="va">fc_total</span>, agg_mat <span class="op">=</span> <span class="va">vnaggmat</span>, weights <span class="op">=</span> <span class="va">p_gsa</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">rf_td_gsa</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:12, 1:525] 50651 21336 24567 29800 22846 ...</span></span>
<span></span>
<span><span class="co"># Proportions of the historical averages - Gross-Sohl method F</span></span>
<span><span class="va">p_gsf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">bts</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">total</span><span class="op">)</span></span>
<span><span class="va">rf_td_gsf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cstd.html">cstd</a></span><span class="op">(</span><span class="va">fc_total</span>, agg_mat <span class="op">=</span> <span class="va">vnaggmat</span>, weights <span class="op">=</span> <span class="va">p_gsf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">rf_td_gsf</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:12, 1:525] 50651 21336 24567 29800 22846 ...</span></span></code></pre></div>
</div>
<p>The level conditional coherent reconciliation (LCC) is a generalization of the the original proposal by <span class="citation" data-cites="Hollyman2021-zq">Hollyman et al. (<a href="#ref-Hollyman2021-zq" role="doc-biblioref">2021</a>)</span> where the reconciled forecasts are conditional to (i.e., constrained by) the base forecasts of a specific upper level of the hierarchy <span class="citation" data-cites="DiFonzo2024-ijf">(<a href="#ref-DiFonzo2024-ijf" role="doc-biblioref">Di Fonzo &amp; Girolimetto, 2024</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_lcc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cslcc.html">cslcc</a></span><span class="op">(</span>base <span class="op">=</span> <span class="va">base</span>, agg_mat <span class="op">=</span> <span class="va">vnaggmat</span>,</span>
<span>                res <span class="op">=</span> <span class="va">res</span>, comb <span class="op">=</span> <span class="st">"wls"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">rf_lcc</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:12, 1:525] 47896 20405 23276 28275 21938 ...</span></span></code></pre></div>
</div>
<p>Finally we can obtained the optimal (in least squares sense) combination cross-sectional reconciled forecast <span class="citation" data-cites="Wickramasuriya2019 Panagiotelis2021-rh Girolimetto2023-ft">(<a href="#ref-Girolimetto2023-ft" role="doc-biblioref">Girolimetto &amp; Di Fonzo, 2023</a>; <a href="#ref-Panagiotelis2021-rh" role="doc-biblioref">Panagiotelis et al., 2021</a>; <a href="#ref-Wickramasuriya2019" role="doc-biblioref">Wickramasuriya et al., 2018</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/csrec.html">csrec</a></span><span class="op">(</span>base <span class="op">=</span> <span class="va">base</span>, agg_mat <span class="op">=</span> <span class="va">vnaggmat</span>, res <span class="op">=</span> <span class="va">res</span>, comb <span class="op">=</span> <span class="st">"shr"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">rf_opt</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:12, 1:525] 49160 21622 24815 29433 23260 ...</span></span></code></pre></div>
</div>
<p>The following table shows some options for the optimal combination cross-sectional reconciliation function <code><a href="../reference/csrec.html">csrec()</a></code>.</p>
<style type="text/css">
.tg .tr-bottom{border:hidden;border-bottom:1px solid black;}
.tg .tg-center{text-align:center;}
.tg .tg-right{text-align:right;}
.tg .tg-left{text-align:left;}
.tg .tg-rvxo{font-size:small;font-style:italic;text-align:left;}
.tg a{color:inherit;text-decoration:none;}
</style>
<table class="table tg" style="table-layout:fixed;width:75%;">
<thead><tr style="border: hidden;border-top-style:solid;border-bottom-style:solid;">
<th class="tg-center">
Projection approach
</th>
<th class="tg-center">
Structural approach
</th>
</tr></thead>
<tbody>
<tr>
<td class="tg-center" colspan="2" style="font-size:small;font-style:italic;">
Standard
</td>
</tr>
<tr class="tr-bottom">
<td class="tg-center" style="border-right-style:double;">
<code>approach="proj"</code> <span class="math display">\[
    \tilde{\mathbf{y}}_h = \left[\mathbf{I}_n - \mathbf{W}\mathbf{C}'(\mathbf{C}\mathbf{W}\mathbf{C}')^{-1}\mathbf{C}\right] \hat{\mathbf{y}}_h
    \]</span>
</td>
<td class="tg-center">
<code>approach="strc"</code> <span class="math display">\[
    \tilde{\mathbf{y}}_h = \mathbf{S}(\mathbf{S}'\mathbf{W}^{-1}\mathbf{S})^{-1}\mathbf{S}'\mathbf{W}^{-1} \hat{\mathbf{y}}_h
    \]</span>
</td>
</tr>
<tr>
<td class="tg-center" colspan="2" style="font-size:small;font-style:italic;border-top-style:solid;">
Non-negative forecast reconciliation (osqp)
</td>
</tr>
<tr class="tr-bottom">
<td class="tg-center" style="border-right-style:double;">
<code>approach="proj"</code> + <code>nn="osqp"</code> <br><br> or <br><code>nn="proj_osqp"</code>
</td>
<td class="tg-center">
<code>approach="strc"</code> + <code>nn="osqp"</code> <br> or <br><code>nn="strc_osqp"</code>
</td>
</tr>
<tr>
<td class="tg-center" colspan="2" style="font-size:small;font-style:italic;border-top-style:solid;">
Non-negative forecast reconciliation (sntz)
</td>
</tr>
<tr class="tr-bottom">
<td class="tg-center" style="border-right-style:double;">
not supported*
</td>
<td class="tg-center">
<code>nn="sntz"</code>
</td>
</tr>
<tr>
<td class="tg-center" colspan="2" style="font-size:small;font-style:italic;border-top-style:solid;">
Immutable forecast reconciliation
</td>
</tr>
<tr class="tr-bottom">
<td class="tg-center" style="border-right-style:double;">
supported
</td>
<td class="tg-center">
supported
</td>
</tr>
</tbody>
<tfoot style="border:hidden;border-top:1px solid black;font-size:small;"><tr>
<td colspan="2">
* If the cross-sectional zero-constraints matrix is <span class="math inline">\(\mathbf{C} = [\mathbf{I}\quad-\mathbf{A}]\)</span>, then <code>nn="sntz"</code> is supported.
</td>
</tr></tfoot>
</table></section><section class="level2"><h3 id="practical-challenges">Practical challenges<a class="anchor" aria-label="anchor" href="#practical-challenges"></a>
</h3>
<section class="level3"><h4 id="non-negativity-issues">Non negativity issues<a class="anchor" aria-label="anchor" href="#non-negativity-issues"></a>
</h4>
<p>Unfortunately, our reconciled forecasts contain negative values, even though we used non-negative base forecasts during the reconciliation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/recoinfo.html">recoinfo</a></span><span class="op">(</span><span class="va">rf_opt</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ Optimal Cross-sectional Forecast Reconciliation</span></span>
<span><span class="co">#&gt; ℹ FoReco function: `csrec`</span></span>
<span><span class="co">#&gt; ℹ Covariance approximation: `shr`</span></span>
<span><span class="co">#&gt; ℹ Non-negative forecasts: `FALSE`</span></span></code></pre></div>
</div>
<p>To address this issue, we can use two approaches:</p>
<ul>
<li>State-of-the-art numerical optimization procedure, <strong>osqp</strong> <span class="citation" data-cites="Stellato2020-jd">(<a href="#ref-Stellato2020-jd" role="doc-biblioref">Stellato et al., 2020</a>)</span>.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_osqp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/csrec.html">csrec</a></span><span class="op">(</span>base <span class="op">=</span> <span class="va">base</span>, agg_mat <span class="op">=</span> <span class="va">vnaggmat</span>, res <span class="op">=</span> <span class="va">res</span>, comb <span class="op">=</span> <span class="st">"shr"</span>, nn <span class="op">=</span> <span class="st">"osqp"</span><span class="op">)</span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/recoinfo.html">recoinfo</a></span><span class="op">(</span><span class="va">rf_osqp</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ Optimal Cross-sectional Forecast Reconciliation</span></span>
<span><span class="co">#&gt; ℹ FoReco function: `csrec`</span></span>
<span><span class="co">#&gt; ℹ Covariance approximation: `shr`</span></span>
<span><span class="co">#&gt; ℹ Non-negative forecasts: `TRUE`</span></span>
<span><span class="va">tmp</span><span class="op">$</span><span class="va">info</span> <span class="co"># OSQP information matrix </span></span>
<span><span class="co">#&gt;     obj_val  run_time iter      pri_res status status_polish</span></span>
<span><span class="co">#&gt; 1 -3197.129 0.2016564  450 4.896219e-11      1             1</span></span></code></pre></div>
</div>
<ul>
<li>Simple heuristic strategy: set-negative-to-zero, <strong>sntz</strong> <span class="citation" data-cites="Di_Fonzo2023-ae">(<a href="#ref-Di_Fonzo2023-ae" role="doc-biblioref">Di Fonzo &amp; Girolimetto, 2023</a>)</span>.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_sntz</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/csrec.html">csrec</a></span><span class="op">(</span>base <span class="op">=</span> <span class="va">base</span>, agg_mat <span class="op">=</span> <span class="va">vnaggmat</span>, res <span class="op">=</span> <span class="va">res</span>, comb <span class="op">=</span> <span class="st">"shr"</span>, </span>
<span>                     nn <span class="op">=</span> <span class="st">"sntz"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/recoinfo.html">recoinfo</a></span><span class="op">(</span><span class="va">rf_sntz</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ Optimal Cross-sectional Forecast Reconciliation</span></span>
<span><span class="co">#&gt; ℹ FoReco function: `csrec`</span></span>
<span><span class="co">#&gt; ℹ Covariance approximation: `shr`</span></span>
<span><span class="co">#&gt; ℹ Non-negative forecasts: `TRUE`</span></span></code></pre></div>
</div>
</section><section class="level3"><h4 id="a-priori-constrained-immutable-forecasts">A priori constrained (immutable) forecasts<a class="anchor" aria-label="anchor" href="#a-priori-constrained-immutable-forecasts"></a>
</h4>
<p>Sometimes we may wish to incorporate a priori knowledge during the reconciliation process <span class="citation" data-cites="Zhang2023-yj">(<a href="#ref-Zhang2023-yj" role="doc-biblioref">Zhang et al., 2023</a>)</span> in order to improve the accuracy of the reconciled forecasts. For example, suppose we want to fix the forecasts of the states level series at the base forecasts values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_imm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/csrec.html">csrec</a></span><span class="op">(</span>base <span class="op">=</span> <span class="va">base</span>, agg_mat <span class="op">=</span> <span class="va">vnaggmat</span>, res <span class="op">=</span> <span class="va">res</span>, comb <span class="op">=</span> <span class="st">"shr"</span>, immutable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">rf_imm</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:12, 1:525] 50403 21300 24398 29664 22962 ...</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rf_imm</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span> <span class="op">-</span> <span class="va">base</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="co">#&gt;          A B C D E F G</span></span>
<span><span class="co">#&gt; Jan 2017 0 0 0 0 0 0 0</span></span>
<span><span class="co">#&gt; Feb 2017 0 0 0 0 0 0 0</span></span>
<span><span class="co">#&gt; Mar 2017 0 0 0 0 0 0 0</span></span>
<span><span class="co">#&gt; Apr 2017 0 0 0 0 0 0 0</span></span>
<span><span class="co">#&gt; May 2017 0 0 0 0 0 0 0</span></span>
<span><span class="co">#&gt; Jun 2017 0 0 0 0 0 0 0</span></span>
<span><span class="co">#&gt; Jul 2017 0 0 0 0 0 0 0</span></span>
<span><span class="co">#&gt; Aug 2017 0 0 0 0 0 0 0</span></span>
<span><span class="co">#&gt; Sep 2017 0 0 0 0 0 0 0</span></span>
<span><span class="co">#&gt; Oct 2017 0 0 0 0 0 0 0</span></span>
<span><span class="co">#&gt; Nov 2017 0 0 0 0 0 0 0</span></span>
<span><span class="co">#&gt; Dec 2017 0 0 0 0 0 0 0</span></span></code></pre></div>
</div>
</section></section><section class="level2"><h3 id="probabilistic-forecast-reconciliation">Probabilistic forecast reconciliation<a class="anchor" aria-label="anchor" href="#probabilistic-forecast-reconciliation"></a>
</h3>
<p><span class="citation" data-cites="Panagiotelis2023-se">Panagiotelis et al. (<a href="#ref-Panagiotelis2023-se" role="doc-biblioref">2023</a>)</span> shows that a sample from the reconciled distribution can be obtained by reconciling a sample from the incoherent distribution. This distinction between the incoherent sample and the reconciliation allows us to separate the two steps.</p>
<p>We can use a non-parametric method, the joint block bootstrap to simulate <span class="math inline">\(B\)</span> samples and then reconciled them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base forecasts' sample:</span></span>
<span><span class="co"># we simulate from the base models by sampling errors </span></span>
<span><span class="co"># while keeping the cross-sectional dimension fixed.</span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">base_csjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/csboot.html">csboot</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">B</span>, <span class="fl">12</span><span class="op">)</span><span class="op">$</span><span class="va">sample</span></span>
<span><span class="va">reco_csjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cssample.html">cssample</a></span><span class="op">(</span><span class="va">base_csjb</span>, agg_mat <span class="op">=</span> <span class="va">vnaggmat</span>, res <span class="op">=</span> <span class="va">res</span>, nn <span class="op">=</span> <span class="st">"sntz"</span>,</span>
<span>                   comb <span class="op">=</span> <span class="st">"shr"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">reco_csjb</span><span class="op">)</span> <span class="co"># distribution object</span></span>
<span><span class="co">#&gt; [1] "distribution" "vctrs_vctr"   "list"</span></span>
<span></span>
<span><span class="co"># Extracts mean:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">reco_csjb</span><span class="op">)</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:12, 1:525] 49476 21591 25240 29994 23470 ...</span></span></code></pre></div>
</div>
<p>A parametric method assumes a normal distribution (Gaussian), to generate the incoherent sample set of forecasts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Gaussian reconciled distribution with fixed base covariance matrix for different forecast horizon</span></span>
<span><span class="va">reco_csg_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/csgauss.html">csgauss</a></span><span class="op">(</span>base <span class="op">=</span> <span class="va">base</span>, agg_mat <span class="op">=</span> <span class="va">vnaggmat</span>, comb <span class="op">=</span> <span class="st">"shr"</span>, res <span class="op">=</span> <span class="va">res</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Gaussian reconciled distribution with different base covariance matrix for each forecast horizon</span></span>
<span><span class="co">## Multi-step residuals</span></span>
<span><span class="va">hres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">residuals</span>, type<span class="op">=</span><span class="st">'response'</span>, h <span class="op">=</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## List of H=12 covariance matrix (one for each forecast horizon)</span></span>
<span><span class="va">cov_shr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">hres</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="fu"><a href="../reference/cscov.html">cscov</a></span><span class="op">(</span>comb <span class="op">=</span> <span class="st">"shr"</span>, res <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">reco_csg_h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">base</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/csgauss.html">csgauss</a></span><span class="op">(</span>base <span class="op">=</span> <span class="va">base</span><span class="op">[</span><span class="va">h</span>, <span class="op">]</span>, agg_mat <span class="op">=</span> <span class="va">vnaggmat</span>, comb <span class="op">=</span> <span class="st">"shr"</span>, res <span class="op">=</span> <span class="va">res</span>, comb_base <span class="op">=</span> <span class="va">cov_shr</span><span class="op">[[</span><span class="va">h</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">reco_csg_h</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">reco_csg_1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">reco_csg_h</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"h-"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">reco_csg_h</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Reconciled sample distribution starting from gaussian base forecasts</span></span>
<span><span class="va">base_css</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">base</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">B</span>, mu <span class="op">=</span> <span class="va">base</span><span class="op">[</span><span class="va">h</span>, <span class="op">]</span>, Sigma <span class="op">=</span> <span class="va">cov_shr</span><span class="op">[[</span><span class="va">h</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">base_css</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">simplify2array</a></span><span class="op">(</span><span class="va">base_css</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">base_css</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">base_csjb</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reco_css</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cssample.html">cssample</a></span><span class="op">(</span><span class="va">base_css</span>, agg_mat <span class="op">=</span> <span class="va">vnaggmat</span>, res <span class="op">=</span> <span class="va">res</span>, nn <span class="op">=</span> <span class="st">"sntz"</span>,</span>
<span>                   comb <span class="op">=</span> <span class="st">"shr"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">reco_css</span><span class="op">)</span> <span class="co"># distribution object</span></span>
<span><span class="co">#&gt; [1] "distribution" "vctrs_vctr"   "list"</span></span></code></pre></div>
</div>
</section></section><section class="section level2"><h2 id="itagdp-general-linearly-constrained-multiple-time-series">
<code>itagdp</code>: general linearly constrained multiple time series<a class="anchor" aria-label="anchor" href="#itagdp-general-linearly-constrained-multiple-time-series"></a>
</h2>
<p>In this section, we work with the <code>itagdp</code> dataset and the corresponding zero-constrained matrix <code>gdpconsmat</code>. This dataset illustrates reconciliation under more complex linear constraints where an unique aggregation is not available. See the <a href="Dataset-vndata-and-itagdp.html">dataset vignette</a> for more details.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">itagdp</span><span class="op">)</span>      <span class="co"># dataset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">gdpconsmat</span><span class="op">)</span>  <span class="co"># Zero-constrained matrix</span></span></code></pre></div>
</div>
<section class="level2"><h3 id="base-forecasts">Base forecasts<a class="anchor" aria-label="anchor" href="#base-forecasts"></a>
</h3>
<p>We fit ARIMA models to each series and generate base forecasts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode<span class="op">=</span><span class="st">'list'</span>, length<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">itagdp</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">itagdp</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fc_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode<span class="op">=</span><span class="st">'list'</span>, length<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">itagdp</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">itagdp</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">itagdp</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">model</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/auto.arima.html" class="external-link">auto.arima</a></span><span class="op">(</span><span class="va">itagdp</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">fc_obj</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">model</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, h <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Point forecasts</span></span>
<span><span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fc_obj</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">base</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Time-Series [1:4, 1:21] from 2020 to 2021: 435117 454372 451935 483302 169348 ...</span></span>
<span><span class="co"># Residuals</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fc_obj</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">res</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Time-Series [1:80, 1:21] from 2000 to 2020: 167.9 89.7 51.4 -43.6 -630.9 ...</span></span></code></pre></div>
</div>
</section><section class="level2"><h3 id="point-forecast-reconciliation-1">Point forecast reconciliation<a class="anchor" aria-label="anchor" href="#point-forecast-reconciliation-1"></a>
</h3>
<p>We apply the optimal reconciliation method to the base forecasts, considering the linear constraints defined by <code>gdpconsmat</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/csrec.html">csrec</a></span><span class="op">(</span>base <span class="op">=</span> <span class="va">base</span>, cons_mat <span class="op">=</span> <span class="va">gdpconsmat</span>, res <span class="op">=</span> <span class="va">res</span>, comb <span class="op">=</span> <span class="st">"wls"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">rf_opt</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:4, 1:21] 434329 453375 451278 482269 169366 ...</span></span></code></pre></div>
</div>
<section class="level3"><h4 id="practical-challenge-immutable-forecast">Practical challenge: immutable forecast<a class="anchor" aria-label="anchor" href="#practical-challenge-immutable-forecast"></a>
</h4>
<p>In this case, we want to fix the forecasts of the top level series (<span class="math inline">\(GDP\)</span>) at the base forecasts values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_imm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/csrec.html">csrec</a></span><span class="op">(</span>base <span class="op">=</span> <span class="va">base</span>, cons_mat <span class="op">=</span> <span class="va">gdpconsmat</span>, res <span class="op">=</span> <span class="va">res</span>, comb <span class="op">=</span> <span class="st">"wls"</span>, immutable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">rf_imm</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:4, 1:21] 435117 454372 451935 483302 169424 ...</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_imm</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="va">base</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="co">#&gt;      Qtr1 Qtr2 Qtr3 Qtr4</span></span>
<span><span class="co">#&gt; 2020    0    0    0    0</span></span></code></pre></div>
</div>
</section></section><section class="level2"><h3 id="probabilistic-forecast-reconciliation-1">Probabilistic forecast reconciliation<a class="anchor" aria-label="anchor" href="#probabilistic-forecast-reconciliation-1"></a>
</h3>
<p>We can use a non-parametric method, the joint block bootstrap to simulate <span class="math inline">\(B\)</span> samples and then reconciled them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base forecasts' sample:</span></span>
<span><span class="co"># we simulate from the base models by sampling errors </span></span>
<span><span class="co"># while keeping the cross-sectional dimension fixed.</span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">base_csjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/csboot.html">csboot</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">B</span>, <span class="fl">4</span><span class="op">)</span><span class="op">$</span><span class="va">sample</span></span>
<span><span class="va">reco_csjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cssample.html">cssample</a></span><span class="op">(</span><span class="va">base_csjb</span>, cons_mat <span class="op">=</span> <span class="va">gdpconsmat</span>, res <span class="op">=</span> <span class="va">res</span>, comb <span class="op">=</span> <span class="st">"shr"</span><span class="op">)</span></span>
<span><span class="va">reco_csjb</span> <span class="co"># distribution object</span></span>
<span><span class="co">#&gt; &lt;distribution[4]&gt;</span></span>
<span><span class="co">#&gt;         h-1         h-2         h-3         h-4 </span></span>
<span><span class="co">#&gt; sample[100] sample[100] sample[100] sample[100]</span></span>
<span></span>
<span><span class="co"># Extracts mean:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">reco_csjb</span><span class="op">)</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:4, 1:21] 434189 452895 450538 481903 169114 ...</span></span></code></pre></div>
</div>
<p>Alternatively, we can use a parametric method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Gaussian reconciled distribution with fixed base covariance matrix for different forecast horizon</span></span>
<span><span class="va">reco_csg_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/csgauss.html">csgauss</a></span><span class="op">(</span>base <span class="op">=</span> <span class="va">base</span>, cons_mat <span class="op">=</span> <span class="va">gdpconsmat</span>, comb <span class="op">=</span> <span class="st">"shr"</span>, res <span class="op">=</span> <span class="va">res</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Gaussian reconciled distribution with different base covariance matrix for each forecast horizon</span></span>
<span><span class="co">## Multi-step residuals</span></span>
<span><span class="va">hres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">residuals</span>, type<span class="op">=</span><span class="st">'response'</span>, h <span class="op">=</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## List of H=12 covariance matrix (one for each forecast horizon)</span></span>
<span><span class="va">cov_shr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">hres</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="fu"><a href="../reference/cscov.html">cscov</a></span><span class="op">(</span>comb <span class="op">=</span> <span class="st">"shr"</span>, res <span class="op">=</span> <span class="va">r</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">reco_csg_h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">base</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/csgauss.html">csgauss</a></span><span class="op">(</span>base <span class="op">=</span> <span class="va">base</span><span class="op">[</span><span class="va">h</span>, <span class="op">]</span>, cons_mat <span class="op">=</span> <span class="va">gdpconsmat</span>, comb <span class="op">=</span> <span class="st">"shr"</span>, res <span class="op">=</span> <span class="va">res</span>, comb_base <span class="op">=</span> <span class="va">cov_shr</span><span class="op">[[</span><span class="va">h</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">reco_csg_h</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">reco_csg_1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">reco_csg_h</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"h-"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">reco_csg_h</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Reconciled sample distribution starting from gaussian base forecasts</span></span>
<span><span class="va">base_css</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">base</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">B</span>, mu <span class="op">=</span> <span class="va">base</span><span class="op">[</span><span class="va">h</span>, <span class="op">]</span>, Sigma <span class="op">=</span> <span class="va">cov_shr</span><span class="op">[[</span><span class="va">h</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">base_css</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">simplify2array</a></span><span class="op">(</span><span class="va">base_css</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">base_css</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">base_csjb</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reco_css</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cssample.html">cssample</a></span><span class="op">(</span><span class="va">base_css</span>, cons_mat <span class="op">=</span> <span class="va">gdpconsmat</span>, res <span class="op">=</span> <span class="va">res</span>, comb <span class="op">=</span> <span class="st">"shr"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">reco_css</span><span class="op">)</span> <span class="co"># distribution object</span></span>
<span><span class="co">#&gt; [1] "distribution" "vctrs_vctr"   "list"</span></span></code></pre></div>
</div>
</section></section><section class="section level2"><h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-Di_Fonzo2023-ae" class="csl-entry" role="listitem">
Di Fonzo, T., &amp; Girolimetto, D. (2023). Spatio-temporal reconciliation of solar forecasts. <em>Solar Energy</em>, <em>251</em>, 13–29. <a href="https://doi.org/10.1016/j.solener.2023.01.003" class="external-link">https://doi.org/10.1016/j.solener.2023.01.003</a>
</div>
<div id="ref-DiFonzo2024-ijf" class="csl-entry" role="listitem">
Di Fonzo, T., &amp; Girolimetto, D. (2024). Forecast combination-based forecast reconciliation: Insights and extensions. <em>International Journal of Forecasting</em>, <em>40</em>(2), 490–514. <a href="https://doi.org/10.1016/j.ijforecast.2022.07.001" class="external-link">https://doi.org/10.1016/j.ijforecast.2022.07.001</a>
</div>
<div id="ref-Dunn1976-kv" class="csl-entry" role="listitem">
Dunn, D. M., Williams, W. H., &amp; Dechaine, T. L. (1976). Aggregate versus subaggregate models in local area forecasting. <em>Journal of the American Statistical Association</em>, <em>71</em>(353), 68–71. <a href="https://doi.org/10.1080/01621459.1976.10481478" class="external-link">https://doi.org/10.1080/01621459.1976.10481478</a>
</div>
<div id="ref-Girolimetto2023-ft" class="csl-entry" role="listitem">
Girolimetto, D., &amp; Di Fonzo, T. (2023). Point and probabilistic forecast reconciliation for general linearly constrained multiple time series. <em>Statistical Methods &amp; Applications</em>. <a href="https://doi.org/10.1007/s10260-023-00738-6" class="external-link">https://doi.org/10.1007/s10260-023-00738-6</a>
</div>
<div id="ref-Gross1990-uf" class="csl-entry" role="listitem">
Gross, C. W., &amp; Sohl, J. E. (1990). Disaggregation methods to expedite product line forecasting. <em>Journal of Forecasting</em>, <em>9</em>(3), 233–254. <a href="https://doi.org/10.1002/for.3980090304" class="external-link">https://doi.org/10.1002/for.3980090304</a>
</div>
<div id="ref-Hollyman2021-zq" class="csl-entry" role="listitem">
Hollyman, R., Petropoulos, F., &amp; Tipping, M. E. (2021). Understanding forecast reconciliation. <em>European Journal of Operational Research</em>, <em>294</em>(1), 149–160. <a href="https://doi.org/10.1016/j.ejor.2021.01.017" class="external-link">https://doi.org/10.1016/j.ejor.2021.01.017</a>
</div>
<div id="ref-Panagiotelis2021-rh" class="csl-entry" role="listitem">
Panagiotelis, A., Athanasopoulos, G., Gamakumara, P., &amp; Hyndman, R. J. (2021). Forecast reconciliation: A geometric view with new insights on bias correction. <em>International Journal of Forecasting</em>, <em>37</em>(1), 343–359. <a href="https://doi.org/10.1016/j.ijforecast.2020.06.004" class="external-link">https://doi.org/10.1016/j.ijforecast.2020.06.004</a>
</div>
<div id="ref-Panagiotelis2023-se" class="csl-entry" role="listitem">
Panagiotelis, A., Gamakumara, P., Athanasopoulos, G., &amp; Hyndman, R. J. (2023). Probabilistic forecast reconciliation: Properties, evaluation and score optimisation. <em>European Journal of Operational Research</em>, <em>306</em>(2), 693–706. <a href="https://doi.org/10.1016/j.ejor.2022.07.040" class="external-link">https://doi.org/10.1016/j.ejor.2022.07.040</a>
</div>
<div id="ref-Stellato2020-jd" class="csl-entry" role="listitem">
Stellato, B., Banjac, G., Goulart, P., Bemporad, A., &amp; Boyd, S. (2020). <span>OSQP</span>: An operator splitting solver for quadratic programs. <em>Mathematical Programming Computation</em>, <em>12</em>(4), 637–672. <a href="https://doi.org/10.1007/s12532-020-00179-2" class="external-link">https://doi.org/10.1007/s12532-020-00179-2</a>
</div>
<div id="ref-Wickramasuriya2019" class="csl-entry" role="listitem">
Wickramasuriya, S. L., Athanasopoulos, G., &amp; Hyndman, R. J. (2018). Optimal Forecast Reconciliation for Hierarchical and Grouped Time Series Through Trace Minimization. <em>Journal of the American Statistical Association</em>, <em>114</em>(526), 804–819. <a href="https://doi.org/10.1080/01621459.2018.1448825" class="external-link">https://doi.org/10.1080/01621459.2018.1448825</a>
</div>
<div id="ref-Wickramasuriya2020-zk" class="csl-entry" role="listitem">
Wickramasuriya, S. L., Turlach, B. A., &amp; Hyndman, R. J. (2020). Optimal non-negative forecast reconciliation. <em>Statistics and Computing</em>, <em>30</em>(5), 1167–1182. <a href="https://doi.org/10.1007/s11222-020-09930-0" class="external-link">https://doi.org/10.1007/s11222-020-09930-0</a>
</div>
<div id="ref-Zhang2023-yj" class="csl-entry" role="listitem">
Zhang, B., Kang, Y., Panagiotelis, A., &amp; Li, F. (2023). Optimal reconciliation with immutable forecasts. <em>European Journal of Operational Research</em>, <em>308</em>(2), 650–660. <a href="https://doi.org/10.1016/j.ejor.2022.11.035" class="external-link">https://doi.org/10.1016/j.ejor.2022.11.035</a>
</div>
</div>
</section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniele Girolimetto, Tommaso Di Fonzo.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
